{% load static %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'home.html' %}" data-command="hogar|inicio|ir a inicio|p√É¬°gina principal">
      <i class="fas fa-home"></i> Hogar
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'carrito' %}" data-command="carrito|mi carrito|ver carrito">
            <i class="fa-solid fa-cart-shopping"></i> Carrito
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'chat' %}" data-command="asistente|chat">
            <i class="fas fa-comments"></i> Asistente
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'tienda' %}" data-command="tienda|productos">
            <i class="fas fa-box"></i> Tienda
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'foro' %}" data-command="foro">
            <i class="fas fa-comments"></i> Foro
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'agregar' %}" data-command="agregar producto">
            <i class="fas fa-plus"></i> Agregar Producto
          </a>
        </li>
      </ul>

      <form class="d-flex me-3" role="search">
        <input class="form-control me-2" type="search" placeholder="Buscar productos..." aria-label="Buscar">
        <button class="btn btn-outline-light" type="submit"><i class="fas fa-search"></i></button>
      </form>

      <!-- Micr√É¬≥fono + Lupa -->
      <div class="d-flex align-items-center me-3">
        <button id="voiceBtn" class="btn btn-outline-light me-2" type="button" title="Navegar por voz">
          <i class="fas fa-microphone"></i>
        </button>
        <button id="zoomBtn" class="btn btn-outline-light me-2" type="button" title="Activar lupa">
          <i class="fas fa-search-plus"></i>
        </button>
        <span id="voiceIndicator" class="badge bg-danger visually-hidden">Escuchando...</span>
      </div>

      <ul class="navbar-nav mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'perfil' %}"><i class="fas fa-user"></i> Usuario</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}"><i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'registro' %}"><i class="fas fa-user-plus"></i> Crear Cuenta</a></li>
      </ul>
    </div>
  </div>
</nav>

<style>
/* Toast de notificaciones */
#voiceToast {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 3000;
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 0.95rem;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
  opacity: 0;
  transition: opacity 0.4s ease;
  pointer-events: none;
}

/* Lente de zoom mejorada */
#magnifyLens {
  position: fixed;
  width: 200px;
  height: 200px;
  border: 3px solid rgba(74, 144, 226, 0.8);
  border-radius: 50%;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.1);
  pointer-events: none;
  display: none;
  z-index: 9999;
  overflow: hidden;
  background: #fff;
  backdrop-filter: blur(2px);
}

#magnifyLens::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 50%;
  box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.1);
  pointer-events: none;
}

#magnifyLens img {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
}

/* Indicador visual cuando zoom est√É¬° activo */
body.zoom-active {
  cursor: crosshair !important;
}

body.zoom-active * {
  cursor: crosshair !important;
}

/* Bot√É¬≥n de zoom activo */
#zoomBtn.active {
  background-color: rgba(74, 144, 226, 0.2);
  border-color: #4a90e2;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ============================================
  // CONFIGURACI√É"N GENERAL
  // ============================================
  const voiceBtn = document.getElementById('voiceBtn');
  const zoomBtn = document.getElementById('zoomBtn');
  const indicator = document.getElementById('voiceIndicator');

  window.voiceListening = false;

  // Toast de notificaciones
  const toast = document.createElement('div');
  toast.id = 'voiceToast';
  toast.setAttribute('role', 'status');
  toast.setAttribute('aria-live', 'polite');
  document.body.appendChild(toast);

  function showToast(msg) {
    toast.textContent = msg;
    toast.style.opacity = '1';
    clearTimeout(toast._t);
    toast._t = setTimeout(() => toast.style.opacity = '0', 3200);
  }

  // Normalize text
  function normalize(s) {
    return String(s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s]/g, '').trim();
  }

  // ============================================
  // LUPA/ZOOM MEJORADA (SIN html2canvas)
  // ============================================
  let zoomEnabled = false;
  const ZOOM_LEVEL = 2.5; // Factor de amplificaci√É¬≥n
  const LENS_SIZE = 200; // Tama√É¬±o de la lente

  // Crear lente
  const lens = document.createElement('div');
  lens.id = 'magnifyLens';
  document.body.appendChild(lens);

  const lensImg = document.createElement('img');
  lens.appendChild(lensImg);

  function enableZoom() {
    if (zoomEnabled) return;
    zoomEnabled = true;
    document.body.classList.add('zoom-active');
    zoomBtn.classList.add('active');
    zoomBtn.innerHTML = '<i class="fas fa-search-minus"></i>';
    showToast('üîé Lupa activada - Mueve el mouse');
    speak('Lupa activada');
  }

  function disableZoom() {
    if (!zoomEnabled) return;
    zoomEnabled = false;
    document.body.classList.remove('zoom-active');
    zoomBtn.classList.remove('active');
    zoomBtn.innerHTML = '<i class="fas fa-search-plus"></i>';
    lens.style.display = 'none';
    showToast('üîé Lupa desactivada');
    speak('Lupa desactivada');
  }

  // Toggle zoom con bot√É¬≥n
  if (zoomBtn) {
    zoomBtn.addEventListener('click', () => {
      zoomEnabled ? disableZoom() : enableZoom();
    });
  }

  // Capturar screenshot de la p√É¬°gina completa (una sola vez)
  let pageScreenshot = null;
  let screenshotWidth = 0;
  let screenshotHeight = 0;

  async function capturePageScreenshot() {
    try {
      // Capturar la p√É¬°gina usando html2canvas
      const canvas = await html2canvas(document.body, {
        allowTaint: true,
        useCORS: true,
        scale: 1,
        logging: false,
        width: document.documentElement.scrollWidth,
        height: document.documentElement.scrollHeight
      });

      pageScreenshot = canvas.toDataURL('image/png');
      screenshotWidth = canvas.width;
      screenshotHeight = canvas.height;

      return true;
    } catch (error) {
      console.error('Error capturando screenshot:', error);
      showToast('‚ö†Ô∏è Error al activar lupa');
      disableZoom();
      return false;
    }
  }

  // Throttle para mousemove
  let lastMoveTime = 0;
  const THROTTLE_MS = 16; // ~60fps

  document.addEventListener('mousemove', async (e) => {
    if (!zoomEnabled) return;

    const now = performance.now();
    if (now - lastMoveTime < THROTTLE_MS) return;
    lastMoveTime = now;

    // Si no hay screenshot, capturarlo
    if (!pageScreenshot) {
      lens.style.display = 'none';
      showToast('üîé Capturando pagina...');
      const success = await capturePageScreenshot();
      if (!success) return;
    }

    // Mostrar lente
    lens.style.display = 'block';

    // Posicionar lente centrada en el cursor
    const lensX = e.clientX - (LENS_SIZE / 2);
    const lensY = e.clientY - (LENS_SIZE / 2);

    lens.style.left = `${lensX}px`;
    lens.style.top = `${lensY}px`;

    // Calcular posici√É¬≥n en la imagen original
    const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
    const scrollY = window.pageYOffset || document.documentElement.scrollTop;

    const sourceX = (e.clientX + scrollX) * ZOOM_LEVEL;
    const sourceY = (e.clientY + scrollY) * ZOOM_LEVEL;

    // Actualizar imagen
    lensImg.src = pageScreenshot;
    lensImg.style.width = `${screenshotWidth * ZOOM_LEVEL}px`;
    lensImg.style.height = `${screenshotHeight * ZOOM_LEVEL}px`;
    lensImg.style.left = `-${sourceX - (LENS_SIZE / 2)}px`;
    lensImg.style.top = `-${sourceY - (LENS_SIZE / 2)}px`;
  });

  // Ocultar lente cuando el mouse sale de la ventana
  document.addEventListener('mouseleave', () => {
    if (zoomEnabled) {
      lens.style.display = 'none';
    }
  });

  // Limpiar screenshot al hacer scroll o resize
  let resetTimeout;
  function scheduleScreenshotReset() {
    clearTimeout(resetTimeout);
    resetTimeout = setTimeout(() => {
      pageScreenshot = null;
      if (zoomEnabled) {
        showToast('Recapturando pagina...');
      }
    }, 500);
  }

  window.addEventListener('scroll', scheduleScreenshotReset);
  window.addEventListener('resize', scheduleScreenshotReset);

  // Desactivar zoom con ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && zoomEnabled) {
      disableZoom();
    }
  });

  // ============================================
  // RECONOCIMIENTO DE VOZ
  // ============================================
  function speak(text) {
    if (!window.speechSynthesis) return;
    try {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'es-CL';
      window.speechSynthesis.speak(utterance);
    } catch (e) {
      console.warn('speak error', e);
    }
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    if (voiceBtn) {
      voiceBtn.addEventListener('click', () => {
        alert('Reconocimiento por voz no soportado en este navegador.');
      });
    }
    return;
  }

  const recog = new SpeechRecognition();
  recog.lang = 'es-CL';
  recog.interimResults = false;
  recog.continuous = true;

  window.voiceListening = sessionStorage.getItem('voiceListening') === '1';

  function updateUIListening(on) {
    window.voiceListening = !!on;
    if (!indicator || !voiceBtn) return;
    indicator.classList.toggle('visually-hidden', !on);
    voiceBtn.innerHTML = on ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
    voiceBtn.setAttribute('aria-pressed', String(on));
  }

  function startListening() {
    try {
      recog.start();
      updateUIListening(true);
      showToast('üéôÔ∏è Escuchando...');
    } catch (e) {
      console.warn('startListening error', e);
    }
  }

function stopListening() {
  try {
    recog.stop();
    updateUIListening(false);
    showToast('üéôÔ∏è Micr√≥fono detenido');
  } catch (e) {
    console.warn('stopListening error', e);
  }
}

  if (voiceBtn) {
    voiceBtn.addEventListener('click', () => {
      window.voiceListening ? stopListening() : startListening();
    });
  }

  window.addEventListener('beforeunload', () => {
    try {
      sessionStorage.setItem('voiceListening', window.voiceListening ? '1' : '0');
    } catch (e) {}
  });

  if (window.voiceListening) {
    setTimeout(() => startListening(), 600);
  }

  let recogRestarting = false;
  recog.addEventListener('end', () => {
    if (!window.voiceListening) return;
    if (recogRestarting) return;
    recogRestarting = true;
    setTimeout(() => {
      try {
        recog.start();
      } catch (e) {
        console.warn('recog restart', e);
      }
      recogRestarting = false;
    }, 400);
  });

  recog.addEventListener('error', (e) => {
    console.error('SpeechRecognition error', e);
    showToast('Error, microfono apagado');
    if (e && e.error === 'not-allowed') {
      speak('Permisos de microfno denegados.');
      stopListening();
    }
  });

  // ============================================
  // COMANDOS DE VOZ
  // ============================================
  recog.addEventListener('result', async (ev) => {
    try {
      const transcript = Array.from(ev.results).map(r => r[0].transcript).join(' ').trim();
      console.log('Voz detectada:', transcript);
      showToast(`üéôÔ∏è "${transcript}"`);
      const t = normalize(transcript);

      // Comandos de navegaci√É¬≥n
      if (/\b(hogar|inicio|home)\b/.test(t)) {
        speak('Volviendo al inicio');
        showToast('√∞≈∏  Inicio');
        window.location.href = "{% url 'home.html' %}";
        return;
      }
if (/\b(carrito)\b/.test(t)) {
  speak('Abriendo carrito');
  showToast('üõí Carrito');
  window.location.href = "{% url 'carrito' %}";
  return;
}

if (/\b(tienda|productos)\b/.test(t)) {
  speak('Abriendo tienda');
  showToast('üõçÔ∏è Tienda');
  window.location.href = "{% url 'tienda' %}";
  return;
}

if (/\b(foro)\b/.test(t)) {
  speak('Abriendo foro');
  showToast('üí¨ Foro');
  window.location.href = "{% url 'foro' %}";
  return;
}

      // Comandos de lupa
      if (/\b(lupa|zoom|acercar|activar lupa)\b/.test(t)) {
        enableZoom();
        return;
      }
      if (/\b(desactivar lupa|quitar lupa|alejar)\b/.test(t)) {
        disableZoom();
        return;
      }

      speak('No entendo¬≠ el comando.');
    } catch (err) {
      console.error('result handler error', err);
    }
  });

  // Cargar html2canvas din√É¬°micamente
  if (!window.html2canvas) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
    script.async = true;
    document.head.appendChild(script);
  }
});
</script>