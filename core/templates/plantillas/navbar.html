{% load static %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <!-- Marca / Hogar -->
    <a class="navbar-brand" href="{% url 'home' %}" data-command="hogar|inicio|ir a inicio|p√°gina principal">
      <i class="fas fa-home"></i> Hogar
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'carrito' %}" data-command="carrito|mi carrito|ver carrito">
            <i class="fa-solid fa-cart-shopping"></i> Carrito
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'chat' %}" data-command="asistente|chat">
            <i class="fas fa-comments"></i> Asistente
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'tienda' %}" data-command="tienda|productos">
            <i class="fas fa-box"></i> Tienda
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'foro' %}" data-command="foro">
            <i class="fas fa-comments"></i> Foro
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'agregar' %}" data-command="agregar producto">
            <i class="fas fa-plus"></i> Agregar Producto
          </a>
        </li>
      </ul>

      <form class="d-flex me-3" role="search">
        <input class="form-control me-2" type="search" placeholder="Buscar productos..." aria-label="Buscar">
        <button class="btn btn-outline-light" type="submit"><i class="fas fa-search"></i></button>
      </form>

      <!-- Micr√É¬≥fono + Lupa -->
      <div class="d-flex align-items-center me-3">
        <button id="voiceBtn" class="btn btn-outline-light me-2" type="button" title="Navegar por voz"
          aria-pressed="false">
          <i class="fas fa-microphone"></i>
        </button>
        <button id="zoomBtn" class="btn btn-outline-light me-2" type="button" title="Activar lupa">
          <i class="fas fa-search-plus"></i>
        </button>
        <span id="voiceIndicator" class="badge bg-danger visually-hidden">Escuchando...</span>
      </div>

      <ul class="navbar-nav mb-2 mb-lg-0">

        {% if user.is_authenticated %}

        <!-- CERRAR SESI√ìN -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'logout' %}">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
          </a>
        </li>

        <!-- PERFIL -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'perfil' %}">
            <i class="fas fa-user"></i> Perfil
          </a>
        </li>

        {% else %}

        <!-- INICIAR SESI√ìN -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'login' %}">
            <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
          </a>
        </li>

        <!-- REGISTRO -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'registro' %}">
            <i class="fas fa-user-plus"></i> Crear Cuenta
          </a>
        </li>

        {% endif %}

      </ul>
    </div>
  </div>
</nav>

<style>
  #voiceToast {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 3000;
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 0.95rem;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  /* --- LUPA (NUEVO) --- */
  .magnify-area {
    position: relative;
    display: inline-block;
    cursor: zoom-in;
  }

  .magnify-lens {
    position: absolute;
    border: 2px solid rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    width: 120px;
    height: 120px;
    overflow: hidden;
    display: none;
    pointer-events: none;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
    z-index: 3000;
  }

  .magnify-lens img {
    position: absolute;
    width: 200%;
    height: auto;
    transform: translate(-50%, -50%);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const voiceBtn = document.getElementById('voiceBtn');
    const indicator = document.getElementById('voiceIndicator');

    // toast simple
    const toast = document.createElement('div');
    toast.id = 'voiceToast';
    toast.style.cssText = 'position:fixed;top:80px;right:20px;z-index:3000;background:rgba(0,0,0,0.85);color:#fff;padding:10px 16px;border-radius:10px;font-size:0.95rem;opacity:0;transition:opacity .34s';
    document.body.appendChild(toast);
    function showToast(msg) { toast.textContent = msg; toast.style.opacity = '1'; clearTimeout(toast._t); toast._t = setTimeout(() => toast.style.opacity = '0', 3200); }

    // util normalizar
    function normalize(s) { return String(s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s]/g, '').trim(); }

    function findScrollableContainer() {
      if (document.scrollingElement && document.scrollingElement.scrollHeight > document.scrollingElement.clientHeight) {
        return document.scrollingElement;
      }
      const candidates = Array.from(document.querySelectorAll('body, html, main, .main-content, .container, .content, #content, .app, .page, .scrollable'));
      for (const el of candidates) {
        try {
          const style = window.getComputedStyle(el);
          const overflowY = style.overflowY;
          if ((overflowY === 'auto' || overflowY === 'scroll' || overflowY === 'overlay') && el.scrollHeight > el.clientHeight + 2) {
            return el;
          }
        } catch (e) { }
      }
      const all = Array.from(document.body.querySelectorAll('*'));
      for (const el of all) {
        try {
          const hasScrollable = el.scrollHeight > el.clientHeight + 2;
          const style = window.getComputedStyle(el);
          if (hasScrollable && /auto|scroll|overlay/.test(style.overflowY)) return el;
        } catch (e) { }
      }
      if (document.documentElement && document.documentElement.scrollHeight > document.documentElement.clientHeight) return document.documentElement;
      if (document.body && document.body.scrollHeight > document.body.clientHeight) return document.body;
      return null;
    }

    async function safeScrollBy(container, amount) {
      if (!container) return false;
      const before = container.scrollTop ?? 0;
      try { container.scrollBy({ top: amount, behavior: 'smooth' }); } catch (e) { container.scrollTop = (container.scrollTop || 0) + amount; }
      await new Promise(res => setTimeout(res, 350));
      const after = container.scrollTop ?? 0;
      if (Math.abs(after - before) > 2) return true;
      const step = amount > 0 ? 100 : -100;
      const steps = Math.ceil(Math.abs(amount) / Math.abs(step));
      for (let i = 0; i < steps; i++) {
        try { container.scrollBy({ top: step, behavior: 'auto' }); } catch (e) { container.scrollTop += step; }
        await new Promise(res => setTimeout(res, 120));
      }
      return (Math.abs((container.scrollTop ?? 0) - before) > 2);
    }

    function speak(text) {
      if (!window.speechSynthesis) return;
      try {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'es-CL';
        window.speechSynthesis.speak(u);
      } catch (e) { console.warn('speak err', e); }
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      voiceBtn.addEventListener('click', () => alert('Reconocimiento por voz no soportado en este navegador.'));
      return;
    }
    const recog = new SpeechRecognition();
    recog.lang = 'es-CL';
    recog.interimResults = false;
    recog.continuous = true;

    let listening = false;
    function startListening() { try { recog.start(); listening = true; indicator.classList.remove('visually-hidden'); voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>'; showToast('üé§ Escuchando...'); } catch (e) { console.warn(e); } }
    function stopListening() { try { recog.stop(); listening = false; indicator.classList.add('visually-hidden'); voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>'; showToast('üõë Micr√≥fono detenido'); } catch (e) { console.warn(e); } }
    voiceBtn.addEventListener('click', () => listening ? stopListening() : startListening());
    recog.addEventListener('end', () => { if (listening) setTimeout(() => { try { recog.start(); } catch (e) { } }, 350); });

    // --- INTEGRACI√ìN DE SLIDER ---
    const sliderCards = Array.from(document.querySelectorAll('.custom-carousel .card[data-command]'));
    const sliderCommands = sliderCards.map(card => {
      const link = card.querySelector('a.btn');
      const title = card.querySelector('.title')?.innerText || 'Producto';
      const phrases = (card.dataset.command || '').split('|').map(normalize);
      return { el: link || card, url: link ? link.href : null, label: title, phrases };
    });

    recog.addEventListener('result', async (ev) => {
      const transcript = Array.from(ev.results).map(r => r[0].transcript).join(' ').trim();
      console.log('Voz detectada:', transcript);
      showToast(`üéß "${transcript}"`);
      const t = normalize(transcript);

      if (/\b(bajar|abajo|scroll down|desplazar abajo|desplazar hacia abajo)\b/.test(t)) {
        const container = findScrollableContainer();
        if (!container) { speak('No encontr√© una √°rea desplazable en esta p√°gina.'); showToast('‚ö†Ô∏è No hay √°rea desplazable detectada'); return; }
        const ok = await safeScrollBy(container, Math.round(container.clientHeight * 0.7));
        if (ok) { speak('Desplazando hacia abajo'); showToast('‚¨áÔ∏è Bajando'); } else { speak('No pude desplazar la p√°gina'); showToast('‚ö†Ô∏è Scroll no disponible'); }
        return;
      }
      if (/\b(subir|arriba|scroll up|desplazar arriba|desplazar hacia arriba)\b/.test(t)) {
        const container = findScrollableContainer();
        if (!container) { speak('No encontr√© una √°rea desplazable en esta p√°gina.'); showToast('‚ö†Ô∏è No hay √°rea desplazable detectada'); return; }
        const ok = await safeScrollBy(container, -Math.round(container.clientHeight * 0.7));
        if (ok) { speak('Desplazando hacia arriba'); showToast('‚¨ÜÔ∏è Subiendo'); } else { speak('No pude desplazar la p√°gina'); showToast('‚ö†Ô∏è Scroll no disponible'); }
        return;
      }

      // ---- COMANDOS DE NAVEGACI√ìN ----
      if (/\b(hogar|inicio|ir a inicio|pagina principal|home)\b/.test(t)) { speak('Volviendo al inicio'); showToast('üè† Abriendo inicio'); window.location.href = "{% url 'home' %}"; return; }
      if (/\b(tienda)\b/.test(t)) { speak('Abriendo tienda'); showToast('‚è≥ Abriendo tienda'); window.location.href = "{% url 'tienda' %}"; return; }
      if (/\b(carrito|mi carrito)\b/.test(t)) { speak('Abriendo carrito'); showToast('‚è≥ Abriendo carrito'); window.location.href = "{% url 'carrito' %}"; return; }

      // --- SLIDER PRODUCTOS ---
      let matched = null;
      for (const cmd of sliderCommands) {
        if (cmd.phrases.some(p => t === p || t.includes(p) || p.includes(t))) {
          matched = cmd;
          break;
        }
      }
      if (matched) {
        speak(`Abriendo ${matched.label}`);
        showToast(`‚úÖ ${matched.label}`);
        if (matched.url) window.location.href = matched.url;
        else matched.el.click();
        return;
      }

      // --- LUPA ---
      if (/\b(lupa|activar lupa|zoom|acercar)\b/.test(t)) { enableZoom(); return; }
      if (/\b(desactivar lupa|quitar lupa|alejar|desactivar zoom)\b/.test(t)) { disableZoom(); return; }

      speak('No entend√≠ el comando. Prueba decir "bajar" o "subir".');
    });

    recog.addEventListener('error', (e) => {
      console.error('SpeechRecognition error', e);
      showToast('‚ö†Ô∏è Error con micr√≥fono');
      if (e.error === 'not-allowed') { speak('Permisos de micr√≥fono denegados.'); stopListening(); }
    });

    window.__getScrollableContainer = findScrollableContainer;

    // ---- LUPA (REEMPLAZADA: improved lens using single screenshot + zoom math) ----
  // Reemplazamos la implementaci√≥n anterior por una que toma UN screenshot completo
  // (con html2canvas) una vez y luego usa un <img> dentro de una lente para mostrar
  // el √°rea ampliada. Esto es m√°s eficiente que render repetidos de html2canvas por movimiento.

  let zoomEnabled = false;
  const ZOOM_LEVEL = 2.5; // factor de amplificaci√≥n
  const LENS_SIZE = 140; // tama√±o de la lente en px

  // Crear lente (se sobrescribe si ya existiera)
  let lensEl = document.getElementById('magnifyLens');
  if (lensEl) lensEl.remove();
  const lens = document.createElement('div');
  lens.id = 'magnifyLens';
  lens.style.cssText = `position:absolute;pointer-events:none;display:none;width:${LENS_SIZE}px;height:${LENS_SIZE}px;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.35);z-index:4000;background:#fff;`;
  const zoomImg = document.createElement('img');
  zoomImg.style.position = 'absolute';
  zoomImg.style.left = '0';
  zoomImg.style.top = '0';
  lens.appendChild(zoomImg);
  document.body.appendChild(lens);

  // Screenshot cache
  let pageScreenshot = null;
  let screenshotWidth = 0;
  let screenshotHeight = 0;
  let lastMoveTime = 0;
  const THROTTLE_MS = 16; // ~60fps cap

  async function capturePageScreenshot(){
    try{
      // ensure html2canvas lib is loaded
      await ensureHtml2canvas();
      // capture full page
      const canvas = await window.html2canvas(document.body, {
        allowTaint: true,
        useCORS: true,
        scale: 1,
        logging: false,
        width: document.documentElement.scrollWidth,
        height: document.documentElement.scrollHeight
      });
      pageScreenshot = canvas.toDataURL('image/png');
      screenshotWidth = canvas.width;
      screenshotHeight = canvas.height;
      return true;
    }catch(err){
      console.warn('capturePageScreenshot error', err);
      showToast('‚ö†Ô∏è Error al activar lupa');
      disableZoom();
      return false;
    }
  }
// ---- LUPA (REEMPLAZADA: screenshot √∫nico + lente sin duplicados) ----
/*
  Implementaci√≥n √∫nica de lupa que:
  - evita duplicados de variables
  - captura UNA vez la p√°gina con html2canvas (lazy)
  - usa un <div> lente con un <img> escalado
  - invalida cache al hacer scroll/resize
*/
(function(){
  // variables encapsuladas para evitar conflictos
  let _zoomEnabled = false;
  const _ZOOM_LEVEL = 2.5;
  const _LENS_SIZE = 140;
  const LENS_ID = 'magnifyLens_v2';

  // si existiera una lente antigua, la removemos (seguro)
  const existing = document.getElementById(LENS_ID);
  if (existing) existing.remove();

  const lens = document.createElement('div');
  lens.id = LENS_ID;
  lens.style.cssText = `position:absolute;pointer-events:none;display:none;width:${_LENS_SIZE}px;height:${_LENS_SIZE}px;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.35);z-index:4000;background:#fff;`;
  const zoomImg = document.createElement('img');
  zoomImg.style.position = 'absolute';
  zoomImg.style.left = '0';
  zoomImg.style.top = '0';
  lens.appendChild(zoomImg);
  document.body.appendChild(lens);

  // cache screenshot
  let pageScreenshot = null;
  let screenshotWidth = 0;
  let screenshotHeight = 0;
  let lastMoveTime = 0;
  const THROTTLE_MS = 16;

  async function ensureHtml2canvasSafe(){
    if (window.html2canvas) return;
    return new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
      s.onload = () => res();
      s.onerror = () => rej(new Error('html2canvas load failed'));
      document.head.appendChild(s);
    });
  }

  async function capturePageScreenshot(){
    try{
      await ensureHtml2canvasSafe();
      const canvas = await window.html2canvas(document.body, {
        allowTaint: true,
        useCORS: true,
        scale: 1,
        logging: false,
        width: document.documentElement.scrollWidth,
        height: document.documentElement.scrollHeight
      });
      pageScreenshot = canvas.toDataURL('image/png');
      screenshotWidth = canvas.width;
      screenshotHeight = canvas.height;
      return true;
    }catch(err){
      console.warn('capturePageScreenshot error', err);
      showToast && showToast('‚ö†Ô∏è Error al activar lupa');
      // si existe la funci√≥n global disableZoom (en tu script original) la llamamos,
      // sino simplemente escondemos la lente localmente
      if (typeof window.disableZoom === 'function') window.disableZoom();
      else { lens.style.display = 'none'; _zoomEnabled = false; }
      return false;
    }
  }

  // funciones p√∫blicas que el resto del script puede invocar
  window.enableZoom = function(){
    if (_zoomEnabled) return;
    _zoomEnabled = true;
    lens.style.display = 'none';
    showToast && showToast('üîç Lupa activada - mueve el mouse');
    speak && speak('Lupa activada');
    // capture will happen lazily on first mousemove
  };

  window.disableZoom = function(){
    if (!_zoomEnabled) return;
    _zoomEnabled = false;
    lens.style.display = 'none';
    pageScreenshot = null;
    showToast && showToast('‚ùå Lupa desactivada');
    speak && speak('Lupa desactivada');
  };

  document.addEventListener('mousemove', async (e) => {
    if (!_zoomEnabled) return;
    const now = performance.now();
    if (now - lastMoveTime < THROTTLE_MS) return;
    lastMoveTime = now;

    if (!pageScreenshot){
      lens.style.display = 'none';
      showToast && showToast('üîé Capturando p√°gina...');
      const ok = await capturePageScreenshot();
      if (!ok) return;
    }

    lens.style.display = 'block';
    const lensX = e.clientX - (_LENS_SIZE / 2);
    const lensY = e.clientY - (_LENS_SIZE / 2);
    lens.style.left = `${lensX}px`;
    lens.style.top = `${lensY}px`;

    const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
    const scrollY = window.pageYOffset || document.documentElement.scrollTop;

    const sourceX = (e.clientX + scrollX) * _ZOOM_LEVEL;
    const sourceY = (e.clientY + scrollY) * _ZOOM_LEVEL;

    zoomImg.src = pageScreenshot;
    zoomImg.style.width = `${screenshotWidth * _ZOOM_LEVEL}px`;
    zoomImg.style.height = `${screenshotHeight * _ZOOM_LEVEL}px`;
    zoomImg.style.left = `-${Math.round(sourceX - (_LENS_SIZE/2))}px`;
    zoomImg.style.top = `-${Math.round(sourceY - (_LENS_SIZE/2))}px`;
  });

  document.addEventListener('mouseleave', () => {
    if (_zoomEnabled) lens.style.display = 'none';
  });

  let resetTimeout;
  function scheduleScreenshotReset(){
    clearTimeout(resetTimeout);
    resetTimeout = setTimeout(()=>{
      pageScreenshot = null;
      if (_zoomEnabled) showToast && showToast('üîÑ Recapturando p√°gina...');
    }, 500);
  }
  window.addEventListener('scroll', scheduleScreenshotReset);
  window.addEventListener('resize', scheduleScreenshotReset);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && _zoomEnabled) window.disableZoom();
  });
})();
 // ---- FIN LUPA REEMPLAZADA ----

  // === üîß MEJORAS DE PERSISTENCIA Y FUNCIONALIDAD ===

  // 1Ô∏è‚É£ Mantener el estado del micr√≥fono entre p√°ginas
  window.addEventListener('beforeunload', () => {
    sessionStorage.setItem('voiceListening', listening ? '1' : '0');
  });
  if (sessionStorage.getItem('voiceListening') === '1') {
    setTimeout(() => startListening(), 600);
  }

    // expose for debugging
  window.__getScrollableContainer = findScrollableContainer;
}); // DOMContentLoaded

// ============================================
// BOT√ìN DE LUPA EN NAVBAR
// ============================================

document.addEventListener("DOMContentLoaded", () => {
  const zoomBtn = document.getElementById("zoomBtn");
  if (!zoomBtn) return;

  let lupaActiva = false;

  zoomBtn.addEventListener("click", () => {
    lupaActiva = !lupaActiva;

    if (lupaActiva) {
      enableZoom();
      zoomBtn.classList.add("btn-success");
      zoomBtn.classList.remove("btn-outline-light");
      zoomBtn.title = "Desactivar lupa";
    } else {
      disableZoom();
      zoomBtn.classList.remove("btn-success");
      zoomBtn.classList.add("btn-outline-light");
      zoomBtn.title = "Activar lupa";
    }
  });
});


  // 2Ô∏è‚É£ Permitir m√∫ltiples comandos de voz seguidos sin errores
  recog.addEventListener('result', () => {
    try {
      recog.stop(); // Reinicia internamente para aceptar comandos nuevos
      setTimeout(() => {
        if (listening) recog.start();
      }, 800);
    } catch (err) {
      console.warn('Auto-restart speech error', err);
    }
  });

  // 3Ô∏è‚É£ Ampliar la funci√≥n de lupa a todo el contenido de la p√°gina
  (function enhanceZoom() {
    const lens = document.querySelector('.magnify-lens');
    const zoomImg = lens.querySelector('img');
    document.addEventListener('mousemove', e => {
      if (!zoomEnabled) return;
      const x = e.pageX;
      const y = e.pageY;
      const scale = 1.8; // nivel de zoom
      lens.style.display = 'block';
      lens.style.left = `${x - lens.offsetWidth / 2}px`;
      lens.style.top = `${y - lens.offsetHeight / 2}px`;

      // Crea una vista aumentada del √°rea bajo el cursor
      html2canvas(document.body, {
        x: x - 60,
        y: y - 60,
        width: 120,
        height: 120,
        scale: scale
      }).then(canvas => {
        zoomImg.src = canvas.toDataURL();
      });
    });
  })();

  // A√±ade script html2canvas si no existe (para renderizar cualquier contenido)
  if (!window.html2canvas) {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
    document.head.appendChild(s);
  }

</script>