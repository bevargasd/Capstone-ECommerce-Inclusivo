{% load static %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap JS (para men√∫ hamburguesa) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- FontAwesome (√≠conos) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <!-- Marca / Hogar -->
    <a class="navbar-brand" href="{% url 'home.html' %}" data-command="hogar|inicio|inicio pagina|ir a inicio">
      <i class="fas fa-home"></i> Hogar
    </a>

    <!-- Bot√≥n hamburguesa -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"
      aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Links -->
    <div class="collapse navbar-collapse" id="mainNavbar">
      <!-- Izquierda -->
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'carrito' %}" data-command="carrito|ver carrito|ir al carrito|mi carrito"> 
            <i class="fa-solid fa-cart-shopping"></i> Carrito
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'chat' %}" data-command="asistente|chat|asistente virtual|abrir asistente">
            <i class="fas fa-comments"></i> Asistente
          </a>  
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'tienda' %}" data-command="tienda|ir a tienda|ver tienda|productos">
            <i class="fas fa-box"></i> Tienda
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'foro' %}" data-command="foro|ir al foro|ver foro">
            <i class="fas fa-comments"></i> Foro
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'agregar' %}" data-command="agregar producto|subir producto|agregar">
            <i class="fas fa-plus"></i> Agregar Producto
          </a>
        </li>
      </ul>

      <!-- Barra de b√∫squeda -->
      <form class="d-flex me-3" role="search">
        <input class="form-control me-2" type="search" placeholder="Buscar productos..." aria-label="Buscar">
        <button class="btn btn-outline-light" type="submit"><i class="fas fa-search"></i></button>
      </form>

      <!-- Bot√≥n micr√≥fono -->
      <div class="d-flex align-items-center me-3">
        <button id="voiceBtn" class="btn btn-outline-light me-2" type="button" title="Navegar por voz" aria-pressed="false">
          <i class="fas fa-microphone"></i>
        </button>
        <span id="voiceIndicator" class="badge bg-danger visually-hidden">Escuchando...</span>
      </div>

      <!-- Derecha -->
      <ul class="navbar-nav mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'perfil' %}" data-command="perfil|mi perfil|ver perfil"><i class="fas fa-user"></i> Usuario</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}" data-command="iniciar sesi√≥n|login|entrar"><i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'registro' %}" data-command="crear cuenta|registro|registrarme"><i class="fas fa-user-plus"></i> Crear Cuenta</a></li>
      </ul>
    </div>
  </div>
</nav>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const voiceBtn = document.getElementById('voiceBtn');
  const indicator = document.getElementById('voiceIndicator');
  const links = Array.from(document.querySelectorAll('.navbar-nav a.nav-link, .navbar-brand'));

  // --- TOAST visual ---
  const toast = document.createElement('div');
  toast.id = 'voiceToast';
  Object.assign(toast.style, {
    position: 'fixed', top: '80px', right: '20px', zIndex: '3000',
    background: 'rgba(0,0,0,0.85)', color: 'white',
    padding: '10px 16px', borderRadius: '10px', fontSize: '0.95rem',
    boxShadow: '0 0 10px rgba(0,0,0,0.4)', transition: 'opacity 0.4s ease', opacity: '0'
  });
  document.body.appendChild(toast);

  function showToast(text) {
    toast.textContent = text;
    toast.style.opacity = '1';
    clearTimeout(toast._hideTimer);
    toast._hideTimer = setTimeout(() => toast.style.opacity = '0', 3500);
  }

  // --- Normalizar texto ---
  function normalize(s) {
    return String(s || '').toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^\w\s]/g, '').trim();
  }

  // --- Configuraci√≥n del reconocimiento ---
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    voiceBtn.addEventListener('click', () => alert('Tu navegador no soporta reconocimiento de voz.'));
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = 'es-CL';
  recognition.interimResults = false;
  recognition.continuous = true;

  let listening = false;
  let allowRestart = true;

  function startListening() {
    try {
      recognition.start();
      listening = true;
      allowRestart = true;
      indicator.classList.remove('visually-hidden');
      voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
      showToast('üé§ Escuchando...');
    } catch (e) {
      console.warn('Error al iniciar reconocimiento:', e);
    }
  }

  function stopListening() {
    try {
      allowRestart = false;
      recognition.stop();
      listening = false;
      indicator.classList.add('visually-hidden');
      voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
      showToast('üõë Micr√≥fono detenido');
    } catch (e) {
      console.warn('Error al detener reconocimiento:', e);
    }
  }

  // --- Levenshtein + similitud ---
  function levenshtein(a, b) {
    if (a === b) return 0;
    const al = a.length, bl = b.length;
    if (al === 0) return bl;
    if (bl === 0) return al;
    const v0 = new Array(bl + 1), v1 = new Array(bl + 1);
    for (let j = 0; j <= bl; j++) v0[j] = j;
    for (let i = 0; i < al; i++) {
      v1[0] = i + 1;
      for (let j = 0; j < bl; j++) {
        const cost = a[i] === b[j] ? 0 : 1;
        v1[j + 1] = Math.min(v1[j] + 1, v0[j + 1] + 1, v0[j] + cost);
      }
      for (let j = 0; j <= bl; j++) v0[j] = v1[j];
    }
    return v1[bl];
  }

  function similarity(a,b) {
    const max = Math.max(a.length, b.length);
    if (max === 0) return 1;
    return (max - levenshtein(a,b)) / max;
  }

  const commands = links.map(a => {
    const raw = a.dataset.command || (a.textContent || a.innerText);
    const phrases = String(raw).split('|').map(s => normalize(s));
    return { el: a, url: a.getAttribute('href'), phrases, label: raw };
  });

  function findBestMatch(transcript) {
    const t = normalize(transcript);
    for (const cmd of commands) {
      for (const p of cmd.phrases) {
        if (t === p || t.includes(p) || p.includes(t)) return { cmd };
      }
    }
    let best = null, bestScore = 0;
    for (const cmd of commands) {
      for (const p of cmd.phrases) {
        const score = similarity(t, p);
        if (score > bestScore) { bestScore = score; best = { cmd }; }
      }
    }
    return bestScore >= 0.6 ? best : null;
  }

  // --- Reconocimiento por voz ---
  voiceBtn.addEventListener('click', () => listening ? stopListening() : startListening());

  recognition.addEventListener('end', () => {
    if (listening && allowRestart) {
      setTimeout(() => {
        try { recognition.start(); } catch {}
      }, 400);
    }
  });

  recognition.addEventListener('result', (ev) => {
    const transcript = Array.from(ev.results).map(r => r[0].transcript).join(' ').trim();
    const t = normalize(transcript);
    console.log('üó£Ô∏è Voz:', t);
    showToast(`üîä Detectado: "${t}"`);

    // --- Scroll ---
    if (/bajar|scroll down|desplazar abajo|hacia abajo/.test(t)) {
      window.scrollBy({ top: window.innerHeight * 0.8, behavior: 'smooth' });
      speak('Desplazando hacia abajo');
      showToast('‚¨áÔ∏è Bajando p√°gina');
      return;
    }
    if (/subir|scroll up|desplazar arriba|hacia arriba/.test(t)) {
      window.scrollBy({ top: -window.innerHeight * 0.8, behavior: 'smooth' });
      speak('Desplazando hacia arriba');
      showToast('‚¨ÜÔ∏è Subiendo p√°gina');
      return;
    }
    if (/ir al inicio|arriba de todo|top/.test(t)) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
      speak('Llev√°ndote al inicio de la p√°gina');
      showToast('‚è´ Ir al inicio');
      return;
    }
    if (/ir al final|abajo de todo|bottom/.test(t)) {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      speak('Desplazando al final de la p√°gina');
      showToast('‚è¨ Ir al final');
      return;
    }

    // --- Navegaci√≥n ---
    const match = findBestMatch(t);
    if (match) {
      const { cmd } = match;
      const message = `Abriendo ${cmd.el.textContent.trim()}`;
      speak(message);
      showToast(`‚úÖ ${message}`);
      if (cmd.url && cmd.url !== '#') window.location.href = cmd.url;
      else cmd.el.click();
    } else {
      speak('No entend√≠ el comando, intenta decir Tienda, Carrito, Foro o subir y bajar.');
      showToast('‚ùå No se reconoci√≥ ning√∫n comando v√°lido');
    }
  });

  recognition.addEventListener('error', (e) => {
    console.error('SpeechRecognition error:', e);
    if (e.error === 'not-allowed') {
      allowRestart = false;
      stopListening();
      speak('No se otorgaron permisos para el micr√≥fono.');
      showToast('‚ö†Ô∏è Micr√≥fono bloqueado');
    } else {
      speak('Hubo un error con el reconocimiento de voz.');
      showToast('‚ö†Ô∏è Error con el micr√≥fono');
    }
  });

  // --- S√≠ntesis ---
  function speak(text) {
    if (!window.speechSynthesis) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'es-CL';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
  }
});
</script>
